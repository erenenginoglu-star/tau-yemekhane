<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>TAÃœ Yemekhane Â· Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --ink: #111111;
      --subtle: #6e6e73;
      --border-soft: rgba(0,0,0,0.08);
      --shadow-soft: 0 18px 46px rgba(0,0,0,0.08);
      --tau-green: #27ae60;
      --premium-gold: #f5b400;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }

    
    body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
    system-ui, -system-ui, "Segoe UI", sans-serif;
  /* background: radial-gradient(circle at top, #ffffff 0, #f5f5f7 42%, #e5e5ea 100%); */
  background: transparent;
  color: var(--ink);
  position: relative;
  overflow-x: hidden;
}

    

    /* DARK MODE */
    body[data-theme="dark"] {
      --ink: #f5f5f7;
      --subtle: #a1a1a6;
      --border-soft: rgba(255,255,255,0.16);
      --shadow-soft: 0 24px 60px rgba(0,0,0,0.7);
      background: radial-gradient(circle at top, #000000 0, #121214 42%, #000000 100%);
      color: var(--ink);
    }

    /* Alman bayrak / background */
    
      .bg-hero {
  position: fixed;
  inset: 0;
  background: url("alman.jpg") center/cover no-repeat;
  filter: blur(4px);   /* 20% blur efekti gibi dÃ¼ÅŸÃ¼nebilirsin */
  opacity: 1;          /* 0.2 yerine 1: artÄ±k arkadaki beyaz gÃ¶rÃ¼nmez */
  pointer-events: none;
  z-index: -1;
}



    body[data-theme="dark"] .bg-hero {
      opacity: 0.3;
      filter: blur(4px) saturate(1.05);
    }

    .top-nav {
      max-width: 1200px;
      margin: 16px auto 0;
      padding: 8px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: var(--subtle);
      position: relative;
      z-index: 1;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-logo-img { height: 40px; width: auto; display: block; }
    .brand-text-main {
      font-size: 14px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #1d1d1f;
    }
    .brand-text-sub { font-size: 12px; color: var(--subtle); }

    body[data-theme="dark"] .brand-text-main {
      color: #f5f5f7;
    }

    .nav-right { display: flex; align-items: center; gap: 10px; }

    .user-pill {
      display: flex; align-items: center; gap: 8px;
      padding: 4px 10px 4px 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(0,0,0,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      cursor: pointer;
    }
    body[data-theme="dark"] .user-pill {
      background: rgba(28,28,30,0.9);
      border-color: rgba(255,255,255,0.16);
      color: #f5f5f7;
    }

    .avatar {
      width: 24px; height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg,#0071e3,#34c759);
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:600;
    }
    .premium-chip {
      display: none;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      background: linear-gradient(135deg,#f5b400,#ffdd55);
      color: #3a2a00;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .premium-chip-dot {
      width: 8px; height: 8px;
      border-radius: 999px;
      background: #fff;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.9);
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #1d1d1f;
    }
    .btn-ghost:hover { background: #f5f5f7; }
    body[data-theme="dark"] .btn-ghost {
      background: rgba(28,28,30,0.9);
      border-color: rgba(255,255,255,0.14);
      color: #f5f5f7;
    }
    body[data-theme="dark"] .btn-ghost:hover {
      background: #2c2c2e;
    }

    .nav-pill {
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.9);
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #1d1d1f;
    }
    .nav-pill:hover { background: #f5f5f7; }
    body[data-theme="dark"] .nav-pill {
      background: rgba(28,28,30,0.9);
      border-color: rgba(255,255,255,0.16);
      color: #f5f5f7;
    }

    .layout {
      max-width: 1200px;
      margin: 18px auto 40px;
      padding: 0 20px 40px;
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 18px;
      position: relative;
      z-index: 1;
    }

    .card-main, .card-block {
      background:#fff;
      border-radius:26px;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
      padding:20px 22px 18px;
    }
    .card-main { padding:22px 24px 20px; }

    body[data-theme="dark"] .card-main,
    body[data-theme="dark"] .card-block {
      background: #1c1c1e;
      border-color: var(--border-soft);
      box-shadow: var(--shadow-soft);
    }

    .section-label {
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--subtle);
      margin-bottom:6px;
    }
    .card-title {
      font-size:22px;
      font-weight:650;
      letter-spacing:-0.03em;
      margin:0 0 14px;
      color:#1d1d1f;
    }
    body[data-theme="dark"] .card-title {
      color:#f5f5f7;
    }

    .card-title-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .balance-row {
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .balance-amount {
      font-size:34px;
      font-weight:650;
      letter-spacing:-0.05em;
      color:#1d1d1f;
    }
    body[data-theme="dark"] .balance-amount {
      color:#f5f5f7;
    }
    .balance-alt {
      font-size:13px;
      color:var(--subtle);
      margin-top:2px;
    }
    .balance-chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:#f5f5f7;
      font-size:12px;
      color:#3a3a3c;
    }
    body[data-theme="dark"] .balance-chip {
      background:#2c2c2e;
      color:#f5f5f7;
      border:1px solid rgba(255,255,255,0.08);
    }
    .balance-sub { font-size:13px; color:var(--subtle); margin-top:4px; }

    .progress-bar-wrap { margin-top:10px; }
    .progress-label-row {
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--subtle);
      margin-bottom:4px;
    }
    .progress-track {
      width:100%; height:7px; border-radius:999px;
      background:#f1f1f4; overflow:hidden;
    }
    .progress-fill {
      height:100%; width:56%;
      border-radius:inherit;
      background:linear-gradient(90deg,#0071e3,#34c759);
    }

    /* Ã–ÄŸÃ¼n counter kartÄ± */
    .meal-counter-card {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 18px;
      background: linear-gradient(
        135deg,
        rgba(0, 113, 227, 0.08),
        rgba(52, 199, 89, 0.12)
      );
      border: 1px solid rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 13px;
      color: #1d1d1f;
    }
    body[data-theme="dark"] .meal-counter-card {
      background: linear-gradient(
        135deg,
        rgba(10, 132, 255, 0.25),
        rgba(48, 209, 88, 0.3)
      );
      border-color: rgba(255,255,255,0.08);
      color:#f5f5f7;
    }

    .meal-counter-label {
      color: var(--subtle);
      font-size: 12px;
      margin-bottom: 2px;
    }
    .meal-counter-value {
      font-size: 20px;
      font-weight: 650;
      letter-spacing: -0.03em;
    }
    .meal-counter-breakdown {
      font-size: 11px;
      color: var(--subtle);
      margin-top: 2px;
    }
    .meal-counter-tag {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(0,0,0,0.06);
      white-space: nowrap;
      text-align: right;
    }
    body[data-theme="dark"] .meal-counter-tag {
      background:#1c1c1e;
      border-color:rgba(255,255,255,0.12);
      color:#f5f5f7;
    }

    /* Paket haklarÄ± kutusu */
    .package-rights-card {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: #f5f5f7;
      border: 1px dashed rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }
    body[data-theme="dark"] .package-rights-card {
      background:#2c2c2e;
      border-color:rgba(255,255,255,0.16);
    }
    .package-rights-title {
      font-size: 12px;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 2px;
    }
    body[data-theme="dark"] .package-rights-title {
      color:#f5f5f7;
    }
    .package-rights-total {
      font-size: 16px;
      font-weight: 600;
    }
    .package-rights-sub {
      font-size: 11px;
      color: var(--subtle);
    }
    .package-rights-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .package-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.06);
    }
    body[data-theme="dark"] .package-tag {
      background:#1c1c1e;
      border-color:rgba(255,255,255,0.12);
      color:#f5f5f7;
    }

    .actions-row {
      display:flex; flex-wrap:wrap;
      gap:10px; margin-top:18px; margin-bottom:6px;
      align-items: center;
    }
    .btn {
      border:none; border-radius:999px;
      padding:10px 18px;
      font-size:14px; font-weight:500;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; cursor:pointer; outline:none;
      transition:transform 120ms ease, box-shadow 120ms ease, background 160ms ease, opacity 120ms ease;
      white-space:nowrap;
    }
    .btn-primary {
      background:linear-gradient(135deg,#00b341,#27ae60);
      color:#fff;
      box-shadow:0 12px 30px rgba(4,182,80,0.45);
      min-width:130px;
    }
    .btn-primary:hover:not(:disabled) {
      background:linear-gradient(135deg,#1adf5f,#00b341);
      transform:translateY(-1px);
      box-shadow:0 16px 38px rgba(4,182,80,0.5);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .btn-secondary {
      background:#f5f5f7;
      color:#111;
      border:1px solid rgba(0,0,0,0.06);
    }
    .btn-secondary:hover {
      background:#e5e5ea;
      transform:translateY(-1px);
    }
    body[data-theme="dark"] .btn-secondary {
      background:#2c2c2e;
      color:#f5f5f7;
      border-color:rgba(255,255,255,0.12);
    }
    body[data-theme="dark"] .btn-secondary:hover {
      background:#3a3a3c;
    }

    .btn-load {
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,0.1);
      box-shadow:0 10px 24px rgba(0,0,0,0.08);
      padding-inline:18px 20px;
      position:relative;
    }
    .btn-load:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(0,0,0,0.12);
    }
    .btn-load.clicked {
      transform:scale(0.97);
      opacity:0.94;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
    }
    .flag-germany {
      width:28px; height:18px;
      border-radius:3px;
      border:1px solid rgba(0,0,0,0.35);
      background-image:linear-gradient(
        to bottom,
        #000000 0 33%,
        #dd0000 33% 66%,
        #ffce00 66% 100%
      );
      background-size:200% 100%;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      transform-origin:left center;
    }
    .btn-load:hover .flag-germany {
      animation:flag-wave .99s ease-in-out infinite alternate;
    }
    @keyframes flag-wave {
      0% { transform:perspective(140px) rotateY(0deg) skewY(0deg); background-position:0 0; }
      50% { transform:perspective(140px) rotateY(-9deg) skewY(-3deg); background-position:40% 0; }
      100% { transform:perspective(140px) rotateY(6deg) skewY(2deg); background-position:80% 0; }
    }
    .badge {
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.12);
      background:rgba(245,245,247,0.9);
      color:#555;
    }

    .card-block + .card-block { margin-top:14px; }
    .list { list-style:none; padding:0; margin:6px 0 0; font-size:13px; color:#3a3a3c; }
    .list-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 0; border-bottom:1px solid rgba(0,0,0,0.04);
    }
    .list-item:last-child { border-bottom:none; }
    .muted { color:var(--subtle); font-size:12px; }

    .stats-row {
      display:flex; gap:14px; margin-top:18px;
      flex-wrap:wrap; font-size:12px; color:var(--subtle);
    }
    .stat-chip {
      padding:6px 9px; border-radius:14px; background:#f5f5f7;
    }
    body[data-theme="dark"] .stat-chip {
      background:#2c2c2e;
      color:#f5f5f7;
    }

    /* Premium kartÄ± */
    .premium-card {
      margin-top: 14px;
      padding: 14px 14px 12px;
      border-radius: 20px;
      border: 1px solid rgba(0,0,0,0.05);
      background: linear-gradient(
        135deg,
        rgba(245, 180, 0, 0.12),
        rgba(255, 230, 160, 0.35)
      );
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .premium-card-active {
      background: linear-gradient(
        135deg,
        rgba(245, 180, 0, 0.25),
        rgba(255, 230, 160, 0.7)
      );
      border-color: rgba(0,0,0,0.1);
    }
    .premium-left {
      flex: 1;
      min-width: 0;
    }
    .premium-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #7a5a00;
      margin-bottom: 4px;
    }
    .premium-title {
      font-size: 16px;
      font-weight: 600;
      color: #3a2a00;
      margin-bottom: 2px;
    }
    .premium-desc {
      font-size: 11px;
      color: #5a4a20;
    }
    .premium-right {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    .premium-price {
      font-size: 18px;
      font-weight: 650;
      color: #3a2a00;
    }
    .premium-price span {
      font-size: 11px;
      font-weight: 400;
      margin-left: 2px;
    }
    .premium-btn {
      padding-inline: 16px;
      font-size: 13px;
    }
    .premium-status {
      font-size: 11px;
      color: #5a4a20;
      min-height: 14px;
    }

    body[data-theme="dark"] .premium-label {
      color:#f5f5f7;
    }
    body[data-theme="dark"] .premium-title {
      color:#f5f5f7;
    }
    body[data-theme="dark"] .premium-desc {
      color:#f5f5f7;
    }
    body[data-theme="dark"] .premium-price {
      color:#f5f5f7;
    }
    body[data-theme="dark"] .premium-status {
      color:#f5f5f7;
    }

    .footer-note {
      max-width:1200px;
      margin:0 auto 24px;
      padding:0 20px;
      font-size:11px;
      color:var(--subtle);
      position: relative;
      z-index: 1;
    }
    body[data-theme="dark"] .footer-note {
      color:var(--subtle);
    }

    /* TAÃœ yemek menÃ¼sÃ¼ iframe */
    .menu-iframe {
      width:100%;
      border:none;
      border-radius:18px;
      height:260px;
      background:#f5f5f7;
      overflow:hidden;
    }
    body[data-theme="dark"] .menu-iframe {
      background:#2c2c2e;
    }

    /* Modal ortak stiller */
    .load-sheet-backdrop,
    .qr-backdrop {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.28);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }
    .load-sheet-backdrop.visible,
    .qr-backdrop.visible {
      display:flex;
    }

    .load-sheet {
      width:100%; max-width:480px;
      background:#fff;
      border-radius:24px;
      box-shadow:0 24px 60px rgba(0,0,0,0.35);
      padding:16px 18px 20px;
      animation:sheet-up .22s ease-out;
    }
    body[data-theme="dark"] .load-sheet {
      background:#1c1c1e;
      color:var(--ink);
    }
    @keyframes sheet-up {
      from{transform:translateY(20px);opacity:0;}
      to{transform:translateY(0);opacity:1;}
    }
    .sheet-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
    }
    .sheet-title { font-size:16px; font-weight:600; color:#1d1d1f; }
    body[data-theme="dark"] .sheet-title {
      color:#f5f5f7;
    }
    .sheet-close {
      border:none; background:#f5f5f7;
      border-radius:999px; padding:4px 9px;
      font-size:12px; cursor:pointer;
    }
    body[data-theme="dark"] .sheet-close {
      background:#2c2c2e;
      color:#f5f5f7;
    }
    .sheet-row { margin-top:10px; margin-bottom:10px; }
    .sheet-label { font-size:12px; color:var(--subtle); margin-bottom:4px; }
    .sheet-input {
      width:100%; padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.12);
      background:#f5f5f7;
      font-size:14px; outline:none;
    }
    .sheet-input:focus {
      background:#fff; border-color:#0071e3;
      box-shadow:0 0 0 2px rgba(0,113,227,0.15);
    }
    body[data-theme="dark"] .sheet-input {
      background:#2c2c2e;
      border-color:rgba(255,255,255,0.16);
      color:#f5f5f7;
    }
    .sheet-footer {
      margin-top:12px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--subtle);
      gap:8px;
    }
    .btn-confirm {
      background:#111; color:#fff;
      border-radius:999px; border:none;
      padding:9px 16px; font-size:14px;
      cursor:pointer;
    }
    .btn-confirm:hover { background:#000; }

    .qr-card {
      width:100%;
      max-width:420px;
      background:#ffffff;
      border-radius:24px;
      padding:18px 18px 20px;
      box-shadow:0 24px 60px rgba(0,0,0,0.4);
      animation:sheet-up .22s ease-out;
    }
    body[data-theme="dark"] .qr-card {
      background:#1c1c1e;
      color:var(--ink);
    }
    .qr-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .qr-title {
      font-size:16px;
      font-weight:600;
      color:#1d1d1f;
    }
    body[data-theme="dark"] .qr-title {
      color:#f5f5f7;
    }
    .qr-close {
      border:none;
      background:#f5f5f7;
      border-radius:999px;
      padding:4px 9px;
      font-size:12px;
      cursor:pointer;
    }
    body[data-theme="dark"] .qr-close {
      background:#2c2c2e;
      color:#f5f5f7;
    }
    .qr-frame {
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .qr-inner {
      position:relative;
      padding:16px;
      border-radius:24px;
      background:#ffffff;
      box-shadow:0 16px 40px rgba(0,0,0,0.18);
      background-image:linear-gradient(135deg,#000000 0%,#dd0000 45%,#ffce00 100%);
      background-origin:border-box;
    }
    .qr-inner::before {
      content:"";
      position:absolute;
      inset:3px;
      border-radius:20px;
      background:#ffffff;
      z-index:0;
    }
    #qrContainer {
      position:relative;
      z-index:1;
    }
    #qrContainer canvas, #qrContainer img {
      width:220px;
      height:220px;
      display:block;
      border-radius:14px;
    }
    .qr-color-hint {
      margin-top:10px;
      font-size:12px;
      color:var(--subtle);
      text-align:center;
    }
    .qr-info {
      margin-top:4px;
      font-size:11px;
      color:#999;
      text-align:center;
    }

    /* Hava durumu kartÄ± */
    .weather-card {
      display:flex; align-items:center; gap:12px;
      padding:12px 14px; border-radius:18px;
      background:linear-gradient(135deg, rgba(0,113,227,0.08), rgba(0,0,0,0.02));
      border:1px solid rgba(0,0,0,0.06);
    }
    body[data-theme="dark"] .weather-card {
      background:linear-gradient(135deg, rgba(10,132,255,0.18), rgba(255,255,255,0.02));
      border-color:rgba(255,255,255,0.14);
    }
    .weather-main { display:flex; align-items:center; gap:10px; }
    .weather-icon { width:48px; height:48px; }
    .weather-temp { font-size:22px; font-weight:650; }
    .weather-meta { font-size:12px; color:var(--subtle); display:flex; gap:10px; flex-wrap:wrap; }
    .weather-city { font-size:12px; color:var(--subtle); }

    @media (max-width:960px) {
      .layout { grid-template-columns:1fr; }
    }
    @media (max-width:720px) {
      .top-nav { padding-inline:12px; }
      .layout { padding-inline:12px; }
      .card-main, .card-block { border-radius:22px; }
      .premium-card { flex-direction: column; align-items: flex-start; }
      .premium-right { align-items: flex-start; text-align: left; }
    }
  </style>
</head>
<body data-theme="light">
  <div class="bg-hero"></div>

  <header class="top-nav">
    <div class="brand">
      <img
        class="brand-logo-img"
        src="https://3fcampus.tau.edu.tr/uploads/cms/pr.tau/dgFfmceK6A.png"
        alt="TÃ¼rk-Alman Ãœniversitesi Logosu"
      />
      <div>
        <div class="brand-text-main">TÃ¼rk-Alman Ãœniversitesi</div>
        <div class="brand-text-sub" id="brandSub">Yemekhane Paneli</div>
      </div>
    </div>
    <div class="nav-right">
      <div class="user-pill" id="accountTrigger" role="button" tabindex="0">
        <div class="avatar" id="avatarInitials">EE</div>
        <span id="userNameTop">KullanÄ±cÄ±</span>
        <span class="premium-chip" id="premiumChip">
          <span class="premium-chip-dot"></span>
          Premium
        </span>
      </div>
      <button type="button" id="themeToggle" class="nav-pill">ðŸŒ™ Dark mode</button>
      <button type="button" id="langToggle" class="nav-pill">ðŸ‡¹ðŸ‡· TR</button>
      <button type="button" id="currencyToggle" class="nav-pill">â‚º â†’ â‚¬</button>
      <button id="logoutBtn" class="btn-ghost">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </header>

  <main class="layout">
    <section class="card-main">
      <div class="section-label" id="sectionBalanceLabel">Yemekhane Â· Bakiye</div>
      <h1 class="card-title" id="cardMainTitle">KampÃ¼s kartÄ±nÄ± bir bakÄ±ÅŸta yÃ¶net.</h1>

      <div class="balance-row">
        <div>
          <div class="balance-amount" id="balanceText">â‚º 0,00</div>
          <div class="balance-alt" id="balanceAltText">â‰ˆ â‚¬ 0,00</div>
          <div class="balance-chip">
            <span id="balanceChipMain">Yemekhane bakiyesi</span>
            <span id="balanceChipSub" style="font-size:10px;opacity:0.7;">TAÃœ CampusCard</span>
          </div>
          <div class="balance-sub" id="lastTxnText">
            Son iÅŸlem bilgisi yÃ¼kleniyor...
          </div>
        </div>
        <div>
          <div class="muted" style="text-align:right;" id="todayEstimateLabel">BugÃ¼nkÃ¼ tahmini harcama</div>
          <div style="font-size:18px;font-weight:600;text-align:right;" id="todayEstimate">â‚º 0,00</div>
        </div>
      </div>

      <div class="progress-bar-wrap">
        <div class="progress-label-row">
          <span id="monthSpendLabel">Bu ayki yemek harcaman</span>
          <span id="monthSummary">â‚º 0 / 1.000</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Ã–ÄŸÃ¼n counter -->
      <div class="meal-counter-card">
        <div>
          <div class="meal-counter-label" id="mealCounterLabel">Toplam tahmini Ã¶ÄŸÃ¼n sayÄ±sÄ±</div>
          <div class="meal-counter-value">
            <span id="mealCounterValue">0</span> <span id="mealWord">Ã¶ÄŸÃ¼n</span>
          </div>
          <div class="meal-counter-breakdown" id="mealCounterBreakdown">
            Bakiyeden: 0 Â· Paketlerden: 0
          </div>
        </div>
        <div class="meal-counter-tag" id="mealCounterTag"></div>
      </div>

      <!-- Paket haklarÄ± kutusu -->
      <div class="package-rights-card">
        <div>
          <div class="package-rights-title" id="packageRightsTitle">Paket dahilindeki haklarÄ±nÄ±z</div>
          <div class="package-rights-total" id="packageTotalMeals">0 Ã¶ÄŸÃ¼n</div>
          <div class="package-rights-sub" id="packageRightsSub">
            SatÄ±n aldÄ±ÄŸÄ±nÄ±z aylÄ±k Ã¶ÄŸle / akÅŸam paketlerinden kalan toplam teorik Ã¶ÄŸÃ¼n.
          </div>
        </div>
        <div class="package-rights-tags">
          <span class="package-tag" id="packageLunchTag">Ã–ÄŸle: 0 Ã¶ÄŸÃ¼n</span>
          <span class="package-tag" id="packageDinnerTag">AkÅŸam: 0 Ã¶ÄŸÃ¼n</span>
        </div>
      </div>

      <!-- ana aksiyon butonlarÄ± -->
      <div class="actions-row">
        <button id="yuklemeBtn" type="button" class="btn btn-load">
          <span id="btnLoadText">YÃ¼kleme Yap</span>
          <span class="flag-germany" aria-hidden="true"></span>
          <span class="badge" id="btnLoadBadge">Hover: ðŸ‡©ðŸ‡ª Â· Click: ðŸ¦…</span>
        </button>
        <button id="qrBtn" type="button" class="btn btn-primary">
          QR ile Ã–de
        </button>
        <button type="button" id="autoLoadBtn" class="btn btn-secondary">
          Otomatik yÃ¼kleme ayarla (yakÄ±nda)
        </button>
      </div>

      <!-- paket butonlarÄ± -->
      <div class="actions-row" style="margin-top:4px;">
        <button id="lunchPkgBtn" type="button" class="btn btn-secondary">
          AylÄ±k Ã–ÄŸle YemeÄŸi Paketi Â· 1.800 TL
        </button>
        <button id="dinnerPkgBtn" type="button" class="btn btn-secondary">
          AylÄ±k AkÅŸam YemeÄŸi Paketi Â· 1.800 TL
        </button>
      </div>

      <div class="stats-row">
        <div class="stat-chip" id="statWeekCount">Bu liste: 0 son iÅŸlem</div>
        <div class="stat-chip" id="statAvgMeal">Ortalama Ã¶ÄŸÃ¼n fiyatÄ±: â‚º 0,00</div>
        <div class="stat-chip" id="statSince">KayÄ±t tarihi: â€”</div>
      </div>

      <!-- Premium kartÄ± -->
      <div class="premium-card" id="premiumCard">
        <div class="premium-left">
          <div class="premium-label" id="premiumLabel">Premium Ã¼yelik</div>
          <div class="premium-title" id="premiumTitle">TAÃœ Yemekhane Premium</div>
          <div class="premium-desc" id="premiumDesc">
            AylÄ±k 299 TL karÅŸÄ±lÄ±ÄŸÄ±nda yemek harcamalarÄ±nda %25 indirim. Ã–ÄŸÃ¼n fiyatÄ±
            60 TL yerine 45 TL olarak hesaplanÄ±r.
          </div>
        </div>
        <div class="premium-right">
          <div class="premium-price" id="premiumPrice">â‚º 299<span id="premiumPriceSuffix">/ay</span></div>
          <button id="premiumBtn" class="btn btn-primary premium-btn">Premium'a GeÃ§</button>
          <div class="premium-status" id="premiumStatus"></div>
        </div>
      </div>
    </section>

    <aside>
      <!-- HAVA DURUMU -->
      <section class="card-block">
        <div class="section-label" id="weatherSectionLabel">KampÃ¼s Â· Hava Durumu</div>
        <h2 class="card-title" id="weatherTitle" style="font-size:18px;margin-bottom:10px;">
          TAÃœ (Beykoz) Â· Åžu an
        </h2>
        <div class="weather-card" id="weatherCard">
          <div class="weather-main">
            <img id="weatherIcon" class="weather-icon" alt="Hava durumu ikonu" src="" />
            <div>
              <div class="weather-temp" id="weatherTemp">â€”Â°C</div>
              <div class="weather-city" id="weatherDesc">â€”</div>
            </div>
          </div>
          <div class="weather-meta">
            <span id="weatherFeels">Hissedilen: â€”Â°C</span>
            <span id="weatherWind">RÃ¼zgar: â€” m/s</span>
            <span id="weatherHum">Nem: â€”%</span>
          </div>
        </div>
        <div class="muted" id="weatherErr" style="margin-top:6px; display:none;"></div>
      </section>

      <!-- SKS yemek menÃ¼sÃ¼ -->
      <section class="card-block" style="margin-top:14px;">
        <div class="section-label" id="menuSectionLabel">BugÃ¼nkÃ¼ menÃ¼</div>
        <h2 class="card-title" id="menuTitle" style="font-size:18px;margin-bottom:6px;">
          TAÃœ SKS Â· Resmi Yemek MenÃ¼sÃ¼
        </h2>
        <iframe
          class="menu-iframe"
          src="https://sks.tau.edu.tr/yemek-menusu"
          title="TAÃœ Yemek MenÃ¼sÃ¼"
        ></iframe>
        <div class="muted" id="menuNote" style="margin-top:6px;">
          MenÃ¼ iÃ§eriÄŸi doÄŸrudan <strong>sks.tau.edu.tr</strong> sitesinden canlÄ± olarak Ã§ekilir.
          (Site iframe'e izin vermezse burada boÅŸ gÃ¶rÃ¼nebilir.)
        </div>
      </section>

      <!-- Son iÅŸlemler + TÃœMÃœNÃœ GÃ–R -->
      <section class="card-block" style="margin-top:14px;">
        <div class="section-label" id="lastTxSectionLabel">Son iÅŸlemler</div>
        <div class="card-title-row" style="margin-bottom:6px;">
          <h2 class="card-title" id="lastTxTitle" style="font-size:18px;margin:0;">
            Hesap hareketleri
          </h2>
          <button id="txPageBtn" class="btn btn-secondary" style="padding:6px 12px;font-size:12px;">
            TÃ¼mÃ¼nÃ¼ gÃ¶r
          </button>
        </div>
        <ul class="list" id="txList">
          <li class="list-item">
            <div>
              <div>Ä°ÅŸlemler yÃ¼kleniyor...</div>
            </div>
          </li>
        </ul>
      </section>

      <!-- Spotify chill paneli -->
      <section class="card-block" style="margin-top:14px;">
        <div class="section-label" id="musicSectionLabel">Chill Â· MÃ¼zik</div>
        <h2 class="card-title" id="musicTitle" style="font-size:16px;margin-bottom:8px;">
          TAÃœ YEMEK sistemini kullanÄ±rken chillemeniz iÃ§in
        </h2>
        <iframe
          style="border-radius:18px; width:100%; height:80px; border:none; margin-top:4px;"
          src="https://open.spotify.com/embed/playlist/37i9dQZF1DX4WYpdgoIcn6?utm_source=generator"
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
          loading="lazy"
        ></iframe>
      </section>
    </aside>
  </main>

  <div class="footer-note" id="footerNote">
    TAÃœ Yemekhane Ã–deme Sistemi Â· Bu arayÃ¼z demo niteliÄŸindedir, gerÃ§ek Ã¶deme iÅŸlemi yapmaz.
  </div>

  <!-- Amerikan ÅŸahini sesi -->
  <audio id="eagle-sound" src="eagle-sound.mp3" preload="auto"></audio>

  <!-- YÃ¼kleme sheet -->
  <div id="loadSheetBackdrop" class="load-sheet-backdrop" aria-hidden="true">
    <div class="load-sheet">
      <div class="sheet-header">
        <div class="sheet-title" id="loadSheetTitle">KartÄ±na demo yÃ¼kleme yap</div>
        <button id="loadClose" class="sheet-close">Kapat</button>
      </div>
      <div class="muted" id="loadSheetDesc">
        Bu demo sadece bakiyeyi artÄ±rÄ±r, gerÃ§ek Ã¶deme almaz. Alman bayraÄŸÄ± hoverâ€™da dalgalanÄ±r, tÄ±klamada Amerikan ÅŸahini sesi gelir.
      </div>

      <div class="sheet-row">
        <div class="sheet-label" id="loadAmountLabel">YÃ¼klenecek tutar (â‚º)</div>
        <input id="loadAmount" class="sheet-input" type="number" min="10" step="10" value="100" />
      </div>

      <div class="sheet-row">
        <div class="sheet-label" id="loadMethodLabel">Ã–deme yÃ¶ntemi (demo)</div>
        <select class="sheet-input" id="loadMethodSelect">
          <option id="loadMethod1">Kredi KartÄ± Â· SanalPOS</option>
          <option id="loadMethod2">Banka KartÄ±</option>
          <option id="loadMethod3">SEPA / Avrupa KartÄ±</option>
        </select>
      </div>

      <div class="sheet-footer">
        <span id="loadStatus">HazÄ±r.</span>
        <button id="loadConfirm" class="btn-confirm">YÃ¼klemeyi Onayla</button>
      </div>
    </div>
  </div>

  <!-- QR modal -->
  <div id="qrBackdrop" class="qr-backdrop" aria-hidden="true">
    <div class="qr-card">
      <div class="qr-header">
        <div class="qr-title" id="qrTitle">QR ile Ã–de</div>
        <button id="qrClose" class="qr-close">Kapat</button>
      </div>
      <div class="muted" id="qrDesc" style="font-size:12px;">
        Telefonunun kamerasÄ±nÄ± bu koda tutarak Ã¶deme verisini okuyabilirsin. Demo amaÃ§lÄ±dÄ±r.
      </div>
      <div class="qr-frame">
        <div class="qr-inner">
          <div id="qrContainer"></div>
        </div>
      </div>
      <div class="qr-color-hint" id="qrHint">
        Kod, <strong>kÄ±rmÄ±zÄ± Â· sarÄ± Â· siyah</strong> tonlu bir Ã§erÃ§eveyle TAÃœ Almanya ruhuna uygun tasarlandÄ±.
      </div>
      <div id="qrInfoText" class="qr-info"></div>
    </div>
  </div>

  <!-- 31 TL ÅŸakasÄ± -->
  <div id="prankBackdrop" class="qr-backdrop" aria-hidden="true">
    <div class="qr-card">
      <div class="qr-header">
        <div class="qr-title" id="prankTitle">Hahahaha :)</div>
        <button id="prankClose" class="qr-close">Kapat</button>
      </div>
      <div class="muted" id="prankText">
        31 TL yÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rdÃ¼k. Bu rakam biraz garip ðŸ˜„<br/>
        Hadi, baÅŸka bir tutar dene.
      </div>
    </div>
  </div>

  <!-- Paket onay modalÄ± -->
  <div id="packageBackdrop" class="qr-backdrop" aria-hidden="true">
    <div class="qr-card">
      <div class="qr-header">
        <div class="qr-title" id="pkgTitle">Paket OnayÄ±</div>
        <button id="pkgClose" class="qr-close">Kapat</button>
      </div>
      <div class="muted" id="pkgDesc">
        Paket detaylarÄ± yÃ¼kleniyor...
      </div>
      <div class="muted" style="margin-top:8px;font-size:13px;">
        Paket fiyatÄ±: <strong>â‚º 1.800</strong> Â· Yemek fiyatÄ±: <strong>â‚º 60</strong><br/>
        <span id="pkgMealsInfo">Bu paketten yaklaÅŸÄ±k 30 Ã¶ÄŸÃ¼n Ã§Ä±kar.</span>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:14px;gap:8px;">
        <button id="pkgCancel" class="qr-close">VazgeÃ§</button>
        <button id="pkgConfirm" class="btn-confirm">OnaylÄ±yorum</button>
      </div>
      <div id="pkgStatus" class="qr-info" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- QR kÃ¼tÃ¼phanesi -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // === CONFIG: OpenWeather ===
    const OPENWEATHER = {
      apiKey: "244ef665d05765e49084025507839e9c", // senin API key
      lat: 41.0866, // TAÃœ Beykoz
      lon: 29.0230,
    };

    // DOM element referanslarÄ±
    const eagleSound = document.getElementById("eagle-sound");
    const loadBtn = document.getElementById("yuklemeBtn");
    const sheetBackdrop = document.getElementById("loadSheetBackdrop");
    const sheetClose = document.getElementById("loadClose");
    const loadConfirm = document.getElementById("loadConfirm");
    const loadStatus = document.getElementById("loadStatus");
    const qrBtn = document.getElementById("qrBtn");
    const qrBackdrop = document.getElementById("qrBackdrop");
    const qrClose = document.getElementById("qrClose");
    const qrInfoText = document.getElementById("qrInfoText");
    const prankBackdrop = document.getElementById("prankBackdrop");
    const prankClose = document.getElementById("prankClose");
    const lunchPkgBtn = document.getElementById("lunchPkgBtn");
    const dinnerPkgBtn = document.getElementById("dinnerPkgBtn");
    const packageBackdrop = document.getElementById("packageBackdrop");
    const pkgTitle = document.getElementById("pkgTitle");
    const pkgDesc = document.getElementById("pkgDesc");
    const pkgMealsInfo = document.getElementById("pkgMealsInfo");
    const pkgStatus = document.getElementById("pkgStatus");
    const pkgClose = document.getElementById("pkgClose");
    const pkgCancel = document.getElementById("pkgCancel");
    const pkgConfirm = document.getElementById("pkgConfirm");
    const premiumBtn = document.getElementById("premiumBtn");
    const premiumCard = document.getElementById("premiumCard");
    const premiumStatus = document.getElementById("premiumStatus");
    const premiumChip = document.getElementById("premiumChip");
    const mealCounterValueEl = document.getElementById("mealCounterValue");
    const mealCounterBreakdownEl = document.getElementById("mealCounterBreakdown");
    const mealCounterTagEl = document.getElementById("mealCounterTag");
    const packageTotalMealsEl = document.getElementById("packageTotalMeals");
    const packageLunchTagEl = document.getElementById("packageLunchTag");
    const packageDinnerTagEl = document.getElementById("packageDinnerTag");
    const premiumLabelEl = document.getElementById("premiumLabel");
    const premiumTitleEl = document.getElementById("premiumTitle");
    const premiumDescEl = document.getElementById("premiumDesc");
    const premiumPriceSuffixEl = document.getElementById("premiumPriceSuffix");
    const themeToggleBtn = document.getElementById("themeToggle");
    const langToggleBtn = document.getElementById("langToggle");
    const accountTrigger = document.getElementById("accountTrigger");
    const currencyToggleBtn = document.getElementById("currencyToggle");
    const balanceAltTextEl = document.getElementById("balanceAltText");
    const txPageBtn = document.getElementById("txPageBtn");
    const loadMethodSelect = document.getElementById("loadMethodSelect");
    const eurRateTextEl = document.getElementById("eurRateText"); // opsiyonel, sayfada yoksa null

    // Weather elements
    const weatherSectionLabel = document.getElementById("weatherSectionLabel");
    const weatherTitle = document.getElementById("weatherTitle");
    const weatherIcon = document.getElementById("weatherIcon");
    const weatherTemp = document.getElementById("weatherTemp");
    const weatherDesc = document.getElementById("weatherDesc");
    const weatherFeels = document.getElementById("weatherFeels");
    const weatherWind = document.getElementById("weatherWind");
    const weatherHum = document.getElementById("weatherHum");
    const weatherErr = document.getElementById("weatherErr");

    let currentUser = null;
    let currentPackageType = null;
    let currentLang = "tr";
    let currentCurrency = "TRY";
    let CURRENCY_EUR_RATE = 49; // varsayÄ±lan, backend'den gÃ¼ncellenecek

    const translations = {
      tr: {
        brandSub: "Yemekhane Paneli",
        logout: "Ã‡Ä±kÄ±ÅŸ",
        sectionBalanceLabel: "Yemekhane Â· Bakiye",
        cardMainTitle: "KampÃ¼s kartÄ±nÄ± bir bakÄ±ÅŸta yÃ¶net.",
        balanceChipMain: "Yemekhane bakiyesi",
        balanceChipSub: "TAÃœ CampusCard",
        lastTxnLoading: "Son iÅŸlem bilgisi yÃ¼kleniyor...",
        todayEstimateLabel: "BugÃ¼nkÃ¼ tahmini harcama",
        monthSpendLabel: "Bu ayki yemek harcaman",
        mealCounterLabel: "Toplam tahmini Ã¶ÄŸÃ¼n sayÄ±sÄ±",
        mealWord: "Ã¶ÄŸÃ¼n",
        mealBreakdown: "Bakiyeden: {balanceMeals} Â· Paketlerden: {packageMeals}",
        mealTagDefault: "Hesaplama: {price} / Ã¶ÄŸÃ¼n",
        mealTagPremium: "Premium: {price} / Ã¶ÄŸÃ¼n (%25 indirim)",
        packageRightsTitle: "Paket dahilindeki haklarÄ±nÄ±z",
        packageRightsSub: "SatÄ±n aldÄ±ÄŸÄ±nÄ±z aylÄ±k Ã¶ÄŸle / akÅŸam paketlerinden kalan toplam teorik Ã¶ÄŸÃ¼n.",
        packageLunchTag: "Ã–ÄŸle: {n} Ã¶ÄŸÃ¼n",
        packageDinnerTag: "AkÅŸam: {n} Ã¶ÄŸÃ¼n",
        btnLoad: "YÃ¼kleme Yap",
        btnQrPay: "QR ile Ã–de",
        btnAutoLoad: "Otomatik yÃ¼kleme ayarla (yakÄ±nda)",
        btnLunchPackage: "AylÄ±k Ã–ÄŸle YemeÄŸi Paketi Â· 1.800 TL",
        btnDinnerPackage: "AylÄ±k AkÅŸam YemeÄŸi Paketi Â· 1.800 TL",
        statWeekCount: "Bu liste: {n} son iÅŸlem",
        statAvgMeal: "Ortalama Ã¶ÄŸÃ¼n fiyatÄ±: {price}",
        statSince: "KayÄ±t tarihi: {date}",
        premiumLabel: "Premium Ã¼yelik",
        premiumTitle: "TAÃœ Yemekhane Premium",
        premiumDesc: "AylÄ±k 299 TL karÅŸÄ±lÄ±ÄŸÄ±nda yemek harcamalarÄ±nda %25 indirim. Ã–ÄŸÃ¼n fiyatÄ± 60 TL yerine 45 TL olarak hesaplanÄ±r.",
        premiumPriceSuffix: "/ay",
        premiumBtnDefault: "Premium'a GeÃ§",
        premiumBtnActive: "Premium Aktif",
        premiumStatusActive: "Yemeklerde %25 indirim uygulanÄ±yor.",
        premiumStatusBuying: "Premium Ã¼yelik satÄ±n alÄ±nÄ±yor...",
        premiumStatusError: "Ä°ÅŸlem baÅŸarÄ±sÄ±z.",
        serverError: "Sunucu hatasÄ±.",
        menuSectionLabel: "BugÃ¼nkÃ¼ menÃ¼",
        menuTitle: "TAÃœ SKS Â· Resmi Yemek MenÃ¼sÃ¼",
        menuNote: "MenÃ¼ iÃ§eriÄŸi doÄŸrudan sks.tau.edu.tr sitesinden canlÄ± olarak Ã§ekilir. (Site iframe'e izin vermezse burada boÅŸ gÃ¶rÃ¼nebilir.)",
        lastTxSectionLabel: "Son iÅŸlemler",
        lastTxTitle: "Hesap hareketleri",
        txSeeAll: "TÃ¼mÃ¼nÃ¼ gÃ¶r",
        txLoading: "Ä°ÅŸlemler yÃ¼kleniyor...",
        txNone: "Ä°ÅŸlem bulunamadÄ±.",
        txOnlineLoad: "Online YÃ¼kleme",
        txSpendDefault: "Yemekhane HarcamasÄ±",
        musicSectionLabel: "Chill Â· MÃ¼zik",
        musicTitle: "TAÃœ YEMEK sistemini kullanÄ±rken chillemeniz iÃ§in",
        footerNote: "TAÃœ Yemekhane Ã–deme Sistemi Â· Bu arayÃ¼z demo niteliÄŸindedir, gerÃ§ek Ã¶deme iÅŸlemi yapmaz.",
        eurRateText: "GÃ¼ncel kur: 1 â‚¬ â‰ˆ {rate}",
        loadSheetTitle: "KartÄ±na demo yÃ¼kleme yap",
        loadSheetDesc: "Bu demo sadece bakiyeyi artÄ±rÄ±r, gerÃ§ek Ã¶deme almaz. Alman bayraÄŸÄ± hoverâ€™da dalgalanÄ±r, tÄ±klamada Amerikan ÅŸahini sesi gelir.",
        loadAmountLabel: "YÃ¼klenecek tutar (â‚º)",
        loadMethodLabel: "Ã–deme yÃ¶ntemi (demo)",
        loadMethod1: "Kredi KartÄ± Â· SanalPOS",
        loadMethod2: "Banka KartÄ±",
        loadMethod3: "SEPA / Avrupa KartÄ±",
        loadStatusReady: "HazÄ±r.",
        loadStatusInvalid: "GeÃ§erli bir tutar gir.",
        loadStatus31: "ðŸ˜„ 31 TL olmaz, baÅŸka bir tutar dene!",
        loadStatusRich: "Bu ne zenginlik be bilader ðŸ˜„",
        loadStatusSending: "YÃ¼kleme gÃ¶nderiliyor...",
        loadStatusError: "YÃ¼kleme hatasÄ±.",
        loadStatusSuccess: "YÃ¼kleme baÅŸarÄ±lÄ±, bakiye gÃ¼ncelleniyor...",
        loadStatusServerError: "Sunucu hatasÄ±.",
        btnClose: "Kapat",
        btnConfirmLoad: "YÃ¼klemeyi Onayla",
        qrTitle: "QR ile Ã–de",
        qrDesc: "Telefonunun kamerasÄ±nÄ± bu koda tutarak Ã¶deme verisini okuyabilirsin. Demo amaÃ§lÄ±dÄ±r.",
        qrHint: "Kod, kÄ±rmÄ±zÄ± Â· sarÄ± Â· siyah tonlu bir Ã§erÃ§eveyle TAÃœ Almanya ruhuna uygun tasarlandÄ±.",
        qrInfo: "Kod iÃ§eriÄŸi: TAU-YEMEK Â· {email}",
        prankTitle: "Hahahaha :)",
        prankText: "31 TL yÃ¼klemeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rdÃ¼k. Bu rakam biraz garip ðŸ˜„\nHadi, baÅŸka bir tutar dene.",
        pkgConfirmTitleLunch: "Ã–ÄŸle YemeÄŸi Paketi",
        pkgConfirmTitleDinner: "AkÅŸam YemeÄŸi Paketi",
        pkgConfirmDescLunch: "AylÄ±k Ã¶ÄŸle yemeÄŸi paketini satÄ±n almak Ã¼zeresin.",
        pkgConfirmDescDinner: "AylÄ±k akÅŸam yemeÄŸi paketini satÄ±n almak Ã¼zeresin.",
        pkgMealsInfo: "Paket: 1.800 TL / 60 TL = 30 Ã¶ÄŸÃ¼n {type}.",
        pkgMealsTypeLunch: "Ã¶ÄŸle yemeÄŸi",
        pkgMealsTypeDinner: "akÅŸam yemeÄŸi",
        pkgStatusBuying: "Paket satÄ±n alÄ±nÄ±yor...",
        pkgStatusError: "Paket alÄ±namadÄ±.",
        pkgStatusSuccess: "Paket satÄ±n alÄ±ndÄ±. Bakiyen gÃ¼ncellendi. Bu paket {meals} Ã¶ÄŸÃ¼n iÃ§erir.",
        pkgStatusServerError: "Sunucu hatasÄ±.",
        btnCancel: "VazgeÃ§",
        btnConfirm: "OnaylÄ±yorum",
        monthSummary: "{spend} / {limit}",
        lastTxnNone: "HenÃ¼z iÅŸlem yok. YÃ¼kleme yaparak baÅŸlayabilirsin.",
        lastTxnSome: "Son iÅŸlem: {date} Â· {amount}",
        todayEstimateZero: "â‚º 0,00",
        weatherSectionLabel: "KampÃ¼s Â· Hava Durumu",
        weatherTitle: "TAÃœ (Beykoz) Â· Åžu an",
        weatherFeels: "Hissedilen: {v}Â°C",
        weatherWind: "RÃ¼zgar: {v} m/s",
        weatherHum: "Nem: {v}%",
        weatherError: "Hava durumu yÃ¼klenemedi."
      },
      de: {
        brandSub: "Mensa-Panel",
        logout: "Abmelden",
        sectionBalanceLabel: "Mensa Â· Guthaben",
        cardMainTitle: "Verwalte deine CampusCard auf einen Blick.",
        balanceChipMain: "Mensa-Guthaben",
        balanceChipSub: "TAU CampusCard",
        lastTxnLoading: "Letzte Buchung wird geladen...",
        todayEstimateLabel: "GeschÃ¤tzte Ausgaben heute",
        monthSpendLabel: "Monatliche Mensa-Ausgaben",
        mealCounterLabel: "GeschÃ¤tzte gesamte Mahlzeiten",
        mealWord: "Mahlzeiten",
        mealBreakdown: "Vom Guthaben: {balanceMeals} Â· Aus Paketen: {packageMeals}",
        mealTagDefault: "Berechnung: {price} / Mahlzeit",
        mealTagPremium: "Premium: {price} / Mahlzeit (25 % Rabatt)",
        packageRightsTitle: "Ihre PaketansprÃ¼che",
        packageRightsSub: "Verbleibende theoretische Mahlzeiten aus Ihren Mittags-/Abendpaketen.",
        packageLunchTag: "Mittag: {n} Mahlzeiten",
        packageDinnerTag: "Abend: {n} Mahlzeiten",
        btnLoad: "Guthaben laden",
        btnQrPay: "Mit QR zahlen",
        btnAutoLoad: "Automatische Aufladung (bald)",
        btnLunchPackage: "Monatliches Mittagspaket Â· 1.800 TL",
        btnDinnerPackage: "Monatliches Abendpaket Â· 1.800 TL",
        statWeekCount: "Liste: letzte {n} Buchungen",
        statAvgMeal: "Durchschnittlicher Mahlzeitenpreis: {price}",
        statSince: "Registriert seit: {date}",
        premiumLabel: "Premium-Mitgliedschaft",
        premiumTitle: "TAU Mensa Premium",
        premiumDesc: "FÃ¼r 299 TL/Monat erhÃ¤ltst du 25 % Rabatt auf Mahlzeiten. Der Preis sinkt von 60 TL auf 45 TL pro Mahlzeit.",
        premiumPriceSuffix: "/Monat",
        premiumBtnDefault: "Zu Premium wechseln",
        premiumBtnActive: "Premium aktiv",
        premiumStatusActive: "25 % Rabatt auf alle Mahlzeiten aktiv.",
        premiumStatusBuying: "Premium-Mitgliedschaft wird gekauft...",
        premiumStatusError: "Vorgang fehlgeschlagen.",
        serverError: "Serverfehler.",
        menuSectionLabel: "Heutiges MenÃ¼",
        menuTitle: "TAU SKS Â· Offizielles Mensa-MenÃ¼",
        menuNote: "Der Inhalt wird live von sks.tau.edu.tr geladen. (Wenn die Seite iFrames blockiert, kann dieses Feld leer bleiben.)",
        lastTxSectionLabel: "Letzte Buchungen",
        lastTxTitle: "Kontobewegungen",
        txSeeAll: "Alle anzeigen",
        txLoading: "Buchungen werden geladen...",
        txNone: "Keine Buchungen gefunden.",
        txOnlineLoad: "Online-Aufladung",
        txSpendDefault: "Mensa-Ausgabe",
        musicSectionLabel: "Chill Â· Musik",
        musicTitle: "Zum Chillen wÃ¤hrend du das TAU-Mensa-System nutzt",
        footerNote: "TAU Mensa-Bezahlsystem Â· Dieses Interface ist eine Demo und fÃ¼hrt keine echten Zahlungen aus.",
        eurRateText: "Aktueller Kurs: 1 â‚¬ â‰ˆ {rate}",
        loadSheetTitle: "Demo-Guthaben aufladen",
        loadSheetDesc: "Diese Demo erhÃ¶ht nur dein Guthaben, ohne echte Zahlung. Die deutsche Flagge weht beim Hover, beim Klick ertÃ¶nt ein Adler-Schrei.",
        loadAmountLabel: "Aufzuladender Betrag (â‚º)",
        loadMethodLabel: "Zahlungsmethode (Demo)",
        loadMethod1: "Kreditkarte Â· Virtual POS",
        loadMethod2: "Debitkarte",
        loadMethod3: "SEPA / EuropÃ¤ische Karte",
        loadStatusReady: "Bereit.",
        loadStatusInvalid: "Bitte einen gÃ¼ltigen Betrag eingeben.",
        loadStatus31: "ðŸ˜„ 31 TL? Probier einen anderen Betrag!",
        loadStatusRich: "Was fÃ¼r ein Reichtum, mein Freund ðŸ˜„",
        loadStatusSending: "Aufladung wird gesendet...",
        loadStatusError: "Aufladefehler.",
        loadStatusSuccess: "Aufladung erfolgreich, Guthaben wird aktualisiert...",
        loadStatusServerError: "Serverfehler.",
        btnClose: "SchlieÃŸen",
        btnConfirmLoad: "Aufladung bestÃ¤tigen",
        qrTitle: "Mit QR zahlen",
        qrDesc: "Richte die Kamera deines Handys auf diesen Code, um die Zahlungsdaten zu lesen. Nur zu Demo-Zwecken.",
        qrHint: "Der Code hat einen Rahmen in Rot Â· Gelb Â· Schwarz â€“ passend zum Deutschland-Motiv.",
        qrInfo: "Code-Inhalt: TAU-YEMEK Â· {email}",
        prankTitle: "Hahahaha :)",
        prankText: "Wir haben gesehen, dass du 31 TL aufladen wolltest. Was ist das denn fÃ¼r ein Betrag? ðŸ˜„\nProbier doch einen anderen.",
        pkgConfirmTitleLunch: "Mittagspaket",
        pkgConfirmTitleDinner: "Abendpaket",
        pkgConfirmDescLunch: "Du bist dabei, das monatliche Mittagspaket zu kaufen.",
        pkgConfirmDescDinner: "Du bist dabei, das monatliche Abendpaket zu kaufen.",
        pkgMealsInfo: "Paket: 1.800 TL / 60 TL = 30 {type}.",
        pkgMealsTypeLunch: "Mittagsmahlzeiten",
        pkgMealsTypeDinner: "Abendmahlzeiten",
        pkgStatusBuying: "Paket wird gekauft...",
        pkgStatusError: "Paket konnte nicht gekauft werden.",
        pkgStatusSuccess: "Paket gekauft. Guthaben aktualisiert. Dieses Paket enthÃ¤lt {meals} Mahlzeiten.",
        pkgStatusServerError: "Serverfehler.",
        btnCancel: "Abbrechen",
        btnConfirm: "Ich bestÃ¤tige",
        monthSummary: "{spend} / {limit}",
        lastTxnNone: "Noch keine Buchung. Du kannst mit einer Aufladung starten.",
        lastTxnSome: "Letzte Buchung: {date} Â· {amount}",
        todayEstimateZero: "â‚º 0,00",
        weatherSectionLabel: "Campus Â· Wetter",
        weatherTitle: "TAU (Beykoz) Â· Jetzt",
        weatherFeels: "GefÃ¼hlt: {v}Â°C",
        weatherWind: "Wind: {v} m/s",
        weatherHum: "Feuchtigkeit: {v}%",
        weatherError: "Wetter konnte nicht geladen werden."
      }
    };

    function t(key, vars = {}) {
      const dict = translations[currentLang] || translations.tr;
      let str = dict[key] || key;
      for (const k in vars) {
        str = str.replace(`{${k}}`, vars[k]);
      }
      return str;
    }

    function applyLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang === "de" ? "de" : "tr";
      const dict = translations[lang] || translations.tr;
      const el = (id) => document.getElementById(id);

      if (el("brandSub")) el("brandSub").textContent = dict.brandSub;
      if (el("logoutBtn")) el("logoutBtn").textContent = dict.logout;
      if (el("sectionBalanceLabel")) el("sectionBalanceLabel").textContent = dict.sectionBalanceLabel;
      if (el("cardMainTitle")) el("cardMainTitle").textContent = dict.cardMainTitle;
      if (el("balanceChipMain")) el("balanceChipMain").textContent = dict.balanceChipMain;
      if (el("balanceChipSub")) el("balanceChipSub").textContent = dict.balanceChipSub;
      if (el("lastTxnText")) el("lastTxnText").textContent = dict.lastTxnLoading;
      if (el("todayEstimateLabel")) el("todayEstimateLabel").textContent = dict.todayEstimateLabel;
      if (el("monthSpendLabel")) el("monthSpendLabel").textContent = dict.monthSpendLabel;
      if (el("mealCounterLabel")) el("mealCounterLabel").textContent = dict.mealCounterLabel;
      if (el("mealWord")) el("mealWord").textContent = dict.mealWord;
      if (el("packageRightsTitle")) el("packageRightsTitle").textContent = dict.packageRightsTitle;
      if (el("packageRightsSub")) el("packageRightsSub").textContent = dict.packageRightsSub;

      const loadTextSpan = el("btnLoadText");
      if (loadTextSpan) loadTextSpan.textContent = dict.btnLoad;
      const qrBtnEl = el("qrBtn");
      if (qrBtnEl) qrBtnEl.textContent = dict.btnQrPay;
      const autoBtnEl = el("autoLoadBtn");
      if (autoBtnEl) autoBtnEl.textContent = dict.btnAutoLoad;
      if (el("lunchPkgBtn")) el("lunchPkgBtn").textContent = dict.btnLunchPackage;
      if (el("dinnerPkgBtn")) el("dinnerPkgBtn").textContent = dict.btnDinnerPackage;

      if (premiumLabelEl) premiumLabelEl.textContent = dict.premiumLabel;
      if (premiumTitleEl) premiumTitleEl.textContent = dict.premiumTitle;
      if (premiumDescEl) premiumDescEl.textContent = dict.premiumDesc;
      if (premiumPriceSuffixEl) premiumPriceSuffixEl.textContent = dict.premiumPriceSuffix;

      if (el("menuSectionLabel")) el("menuSectionLabel").textContent = dict.menuSectionLabel;
      if (el("menuTitle")) el("menuTitle").textContent = dict.menuTitle;
      if (el("menuNote")) el("menuNote").textContent = dict.menuNote;

      if (el("lastTxSectionLabel")) el("lastTxSectionLabel").textContent = dict.lastTxSectionLabel;
      if (el("lastTxTitle")) el("lastTxTitle").textContent = dict.lastTxTitle;
      if (el("txPageBtn")) el("txPageBtn").textContent = dict.txSeeAll;

      if (el("musicSectionLabel")) el("musicSectionLabel").textContent = dict.musicSectionLabel;
      if (el("musicTitle")) el("musicTitle").textContent = dict.musicTitle;

      if (el("footerNote")) el("footerNote").textContent = dict.footerNote;

      if (el("loadSheetTitle")) el("loadSheetTitle").textContent = dict.loadSheetTitle;
      if (el("loadSheetDesc")) el("loadSheetDesc").textContent = dict.loadSheetDesc;
      if (el("loadAmountLabel")) el("loadAmountLabel").textContent = dict.loadAmountLabel;
      if (el("loadMethodLabel")) el("loadMethodLabel").textContent = dict.loadMethodLabel;

      if (loadMethodSelect && loadMethodSelect.options.length >= 3) {
        loadMethodSelect.options[0].textContent = dict.loadMethod1;
        loadMethodSelect.options[1].textContent = dict.loadMethod2;
        loadMethodSelect.options[2].textContent = dict.loadMethod3;
      }

      if (sheetClose) sheetClose.textContent = dict.btnClose;
      if (loadConfirm) loadConfirm.textContent = dict.btnConfirmLoad;
      if (loadStatus) loadStatus.textContent = dict.loadStatusReady;

      if (document.getElementById("qrTitle")) document.getElementById("qrTitle").textContent = dict.qrTitle;
      if (document.getElementById("qrDesc")) document.getElementById("qrDesc").textContent = dict.qrDesc;
      if (document.getElementById("qrHint")) document.getElementById("qrHint").textContent = dict.qrHint;
      if (qrClose) qrClose.textContent = dict.btnClose;

      if (prankClose) prankClose.textContent = dict.btnClose;
      if (document.getElementById("prankTitle")) document.getElementById("prankTitle").textContent = dict.prankTitle;
      if (document.getElementById("prankText")) document.getElementById("prankText").textContent = dict.prankText;
      if (pkgClose) pkgClose.textContent = dict.btnClose;
      if (pkgCancel) pkgCancel.textContent = dict.btnCancel;
      if (pkgConfirm) pkgConfirm.textContent = dict.btnConfirm;

      // Weather texts
      if (weatherSectionLabel) weatherSectionLabel.textContent = dict.weatherSectionLabel;
      if (weatherTitle) weatherTitle.textContent = dict.weatherTitle;

      if (langToggleBtn) {
        langToggleBtn.textContent = lang === "tr" ? "ðŸ‡¹ðŸ‡· TR" : "ðŸ‡©ðŸ‡ª DE";
      }

      // Kur metnini seÃ§ili dile gÃ¶re gÃ¼ncelle (opsiyonel element)
      if (eurRateTextEl && CURRENCY_EUR_RATE) {
        const rateStr = "â‚º " + CURRENCY_EUR_RATE.toFixed(2).replace(".", ",");
        eurRateTextEl.textContent = t("eurRateText", { rate: rateStr });
      }

      // Dil deÄŸiÅŸince hava durumunu tekrar yÃ¼kle
      loadWeather();
    }

    function applyTheme(theme) {
      document.body.dataset.theme = theme;
      if (themeToggleBtn) {
        themeToggleBtn.textContent =
          theme === "dark" ? "â˜€ï¸ Light mode" : "ðŸŒ™ Dark mode";
      }
    }

    function updateCurrencyToggleLabel() {
      if (!currencyToggleBtn) return;
      currencyToggleBtn.textContent =
        currentCurrency === "TRY" ? "â‚º â†’ â‚¬" : "â‚¬ â†’ â‚º";
    }

    (function initTheme() {
      try {
        const saved = localStorage.getItem("tau-theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        const initial = saved || (prefersDark ? "dark" : "light");
        applyTheme(initial);
      } catch (e) {
        applyTheme("light");
      }
    })();

    (function initLang() {
      try {
        const saved = localStorage.getItem("tau-lang");
        const initial = saved === "de" ? "de" : "tr";
        applyLanguage(initial);
      } catch (e) {
        applyLanguage("tr");
      }
    })();

    (function initCurrency() {
      try {
        const saved = localStorage.getItem("tau-currency");
        currentCurrency = saved === "EUR" ? "EUR" : "TRY";
      } catch (e) {
        currentCurrency = "TRY";
      }
      updateCurrencyToggleLabel();
    })();

    if (themeToggleBtn) {
      themeToggleBtn.addEventListener("click", () => {
        const next = document.body.dataset.theme === "dark" ? "light" : "dark";
        applyTheme(next);
        try {
          localStorage.setItem("tau-theme", next);
        } catch (e) {}
      });
    }

    if (langToggleBtn) {
      langToggleBtn.addEventListener("click", () => {
        const next = currentLang === "tr" ? "de" : "tr";
        applyLanguage(next);
        try {
          localStorage.setItem("tau-lang", next);
        } catch (e) {}
        if (currentUser) {
          loadUser();
        }
      });
    }

    if (accountTrigger) {
      accountTrigger.addEventListener("click", () => {
        window.location.href = "/account.html";
      });
      accountTrigger.addEventListener("keypress", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          window.location.href = "/account.html";
        }
      });
    }

    if (txPageBtn) {
      txPageBtn.addEventListener("click", () => {
        window.location.href = "/transactions.html";
      });
    }

    if (currencyToggleBtn) {
      currencyToggleBtn.addEventListener("click", () => {
        currentCurrency = currentCurrency === "TRY" ? "EUR" : "TRY";
        updateCurrencyToggleLabel();
        try {
          localStorage.setItem("tau-currency", currentCurrency);
        } catch (e) {}
        renderBalanceCurrency();
      });
    }

    function formatTL(amount) {
      return "â‚º " + amount.toFixed(2).replace(".", ",");
    }
    function formatEUR(amount) {
      return "â‚¬ " + amount.toFixed(2).replace(".", ",");
    }

    function renderBalanceCurrency() {
      if (!currentUser) return;
      const balanceEl = document.getElementById("balanceText");
      const amountTL = currentUser.balance || 0;
      const amountEUR = amountTL / CURRENCY_EUR_RATE;
      if (currentCurrency === "TRY") {
        if (balanceEl) balanceEl.textContent = formatTL(amountTL);
        if (balanceAltTextEl) balanceAltTextEl.textContent = "â‰ˆ " + formatEUR(amountEUR);
      } else {
        if (balanceEl) balanceEl.textContent = formatEUR(amountEUR);
        if (balanceAltTextEl) balanceAltTextEl.textContent = "â‰ˆ " + formatTL(amountTL);
      }
    }

    // -------- YÃ¼kleme sheet --------
    function openSheet() {
      sheetBackdrop.classList.add("visible");
      sheetBackdrop.setAttribute("aria-hidden", "false");
      loadStatus.textContent = t("loadStatusReady");
    }
    function closeSheet() {
      sheetBackdrop.classList.remove("visible");
      sheetBackdrop.setAttribute("aria-hidden", "true");
    }

    if (loadBtn) {
      loadBtn.addEventListener("click", () => {
        // KÃ¼Ã§Ã¼k bir tÄ±klama animasyonu
        loadBtn.classList.add("clicked");
        setTimeout(() => loadBtn.classList.remove("clicked"), 150);

        // TÄ±klandÄ±ÄŸÄ±nda Amerikan ÅŸahini sesi
        if (eagleSound) {
          try {
            eagleSound.currentTime = 0;
            eagleSound.play().catch(() => {});
          } catch (e) {}
        }

        // YÃ¼kleme iÅŸlemini artÄ±k ayrÄ± bir sayfada yapÄ±yoruz
        window.location.href = "/aufladen.html";
      });
    }

    if (sheetClose) sheetClose.addEventListener("click", closeSheet);
    if (sheetBackdrop) {
      sheetBackdrop.addEventListener("click", (e) => {
        if (e.target === sheetBackdrop) closeSheet();
      });
    }

    // 31 TL ve 20.000+ kontrolleri (sheet Ã¼zerinden yapÄ±lÄ±rsa)
    if (prankClose) {
      prankClose.addEventListener("click", () => {
        prankBackdrop.classList.remove("visible");
        prankBackdrop.setAttribute("aria-hidden", "true");
      });
    }
    if (prankBackdrop) {
      prankBackdrop.addEventListener("click", (e) => {
        if (e.target === prankBackdrop) {
          prankBackdrop.classList.remove("visible");
          prankBackdrop.setAttribute("aria-hidden", "true");
        }
      });
    }

    if (loadConfirm) {
      loadConfirm.addEventListener("click", async () => {
        const amount = Number(document.getElementById("loadAmount").value || 0);

        if (!amount || amount <= 0) {
          loadStatus.textContent = t("loadStatusInvalid");
          return;
        }

        // 31 TL ÅŸakasÄ±
        if (amount === 31) {
          loadStatus.textContent = t("loadStatus31");
          prankBackdrop.classList.add("visible");
          prankBackdrop.setAttribute("aria-hidden", "false");
          return;
        }

        // 20.000 TL Ã¼stÃ¼ zengin uyarÄ±sÄ±
        if (amount > 20000) {
          loadStatus.textContent = t("loadStatusRich");
          return;
        }

        loadStatus.textContent = t("loadStatusSending");
        try {
          const res = await fetch("/api/demo-load", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount }),
          });
          const data = await res.json();
          if (!res.ok) {
            loadStatus.textContent = data.error || t("loadStatusError");
            return;
          }
          loadStatus.textContent = t("loadStatusSuccess");
          await loadUser();
        } catch (err) {
          loadStatus.textContent = t("loadStatusServerError");
        }
      });
    }

    // -------- Ã‡Ä±kÄ±ÅŸ --------
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await fetch("/api/logout", { method: "POST" });
        window.location.href = "/";
      });
    }

    // -------- QR modalÄ± --------
    function openQrModal() {
      if (!currentUser) return;

      const payload = `TAU-YEMEK|UID=${currentUser.id}|EMAIL=${currentUser.email}|TS=${Date.now()}`;

      const container = document.getElementById("qrContainer");
      container.innerHTML = "";
      new QRCode(container, {
        text: payload,
        width: 220,
        height: 220,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M,
      });

      qrInfoText.textContent = t("qrInfo", { email: currentUser.email });
      qrBackdrop.classList.add("visible");
      qrBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeQrModal() {
      qrBackdrop.classList.remove("visible");
      qrBackdrop.setAttribute("aria-hidden", "true");
    }

    if (qrBtn) qrBtn.addEventListener("click", openQrModal);
    if (qrClose) qrClose.addEventListener("click", closeQrModal);
    if (qrBackdrop) {
      qrBackdrop.addEventListener("click", (e) => {
        if (e.target === qrBackdrop) closeQrModal();
      });
    }

    // -------- Paket modalÄ± --------
    function openPackageModal(type) {
      currentPackageType = type;
      const isLunch = type === "lunch";
      pkgTitle.textContent = isLunch ? t("pkgConfirmTitleLunch") : t("pkgConfirmTitleDinner");
      pkgDesc.textContent = isLunch ? t("pkgConfirmDescLunch") : t("pkgConfirmDescDinner");
      const typeLabel = isLunch ? t("pkgMealsTypeLunch") : t("pkgMealsTypeDinner");
      pkgMealsInfo.textContent = t("pkgMealsInfo", { type: typeLabel });
      pkgStatus.textContent = "";

      packageBackdrop.classList.add("visible");
      packageBackdrop.setAttribute("aria-hidden", "false");
    }

    function closePackageModal() {
      packageBackdrop.classList.remove("visible");
      packageBackdrop.setAttribute("aria-hidden", "true");
      currentPackageType = null;
    }

    if (lunchPkgBtn) lunchPkgBtn.addEventListener("click", () => openPackageModal("lunch"));
    if (dinnerPkgBtn) dinnerPkgBtn.addEventListener("click", () => openPackageModal("dinner"));
    if (pkgClose) pkgClose.addEventListener("click", closePackageModal);
    if (pkgCancel) pkgCancel.addEventListener("click", closePackageModal);
    if (packageBackdrop) {
      packageBackdrop.addEventListener("click", (e) => {
        if (e.target === packageBackdrop) closePackageModal();
      });
    }

    if (pkgConfirm) {
      pkgConfirm.addEventListener("click", async () => {
        if (!currentPackageType) return;
        pkgStatus.textContent = t("pkgStatusBuying");

        try {
          const res = await fetch("/api/buy-package", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ packageType: currentPackageType }),
          });
          const data = await res.json();
          if (!res.ok) {
            pkgStatus.textContent = data.error || t("pkgStatusError");
            return;
          }
          pkgStatus.textContent = t("pkgStatusSuccess", { meals: data.meals });
          await loadUser();
        } catch (err) {
          pkgStatus.textContent = t("pkgStatusServerError");
        }
      });
    }

    // -------- Premium butonu --------
    if (premiumBtn) {
      premiumBtn.addEventListener("click", async () => {
        if (!currentUser || currentUser.is_premium) return;
        premiumStatus.textContent = t("premiumStatusBuying");

        try {
          const res = await fetch("/api/subscribe-premium", {
            method: "POST",
          });
          const data = await res.json();
          if (!res.ok) {
            premiumStatus.textContent = data.error || t("premiumStatusError");
            return;
          }
          premiumStatus.textContent = t("premiumStatusActive");
          await loadUser();
        } catch (err) {
          premiumStatus.textContent = t("serverError");
        }
      });
    }

    // -------- KullanÄ±cÄ± verisi --------
    async function loadUser() {
      try {
        const res = await fetch("/api/me");
        if (res.status === 401) {
          window.location.href = "/";
          return;
        }
        const data = await res.json();

        // EUR kuru backend'den geliyorsa gÃ¼ncelle
        if (typeof data.eurRate === "number" && data.eurRate > 0) {
          CURRENCY_EUR_RATE = data.eurRate;
          if (eurRateTextEl) {
            const rateStr = "â‚º " + data.eurRate.toFixed(2).replace(".", ",");
            eurRateTextEl.textContent = t("eurRateText", { rate: rateStr });
          }
        } else if (eurRateTextEl) {
          eurRateTextEl.textContent = "";
        }

        const user = data.user;
        const txs = data.transactions || [];
        const pkg = data.packageInfo || {
          lunchMeals: 0,
          dinnerMeals: 0,
          totalMeals: 0,
        };
        currentUser = user;

        document.getElementById("userNameTop").textContent = user.name;
        const initials = (user.name || "K").split(" ")
          .map((p) => p[0]?.toUpperCase())
          .slice(0, 2)
          .join("");
        document.getElementById("avatarInitials").textContent = initials || "U";

        const mealPrice = user.is_premium ? 45 : 60;

        // Premium badge / text
        if (user.is_premium) {
          premiumChip.style.display = "inline-flex";
          premiumCard.classList.add("premium-card-active");
          premiumBtn.textContent = t("premiumBtnActive");
          premiumBtn.disabled = true;
          premiumStatus.textContent = t("premiumStatusActive");
          mealCounterTagEl.textContent = t("mealTagPremium", { price: "â‚º " + mealPrice });
        } else {
          premiumChip.style.display = "none";
          premiumCard.classList.remove("premium-card-active");
          premiumBtn.textContent = t("premiumBtnDefault");
          premiumBtn.disabled = false;
          premiumStatus.textContent = "";
          mealCounterTagEl.textContent = t("mealTagDefault", { price: "â‚º " + mealPrice });
        }

        // Ã–ÄŸÃ¼n hesabÄ±
        const balanceMeals = Math.floor(user.balance / mealPrice);
        const packageMeals = pkg.totalMeals || 0;
        const totalMeals = balanceMeals + packageMeals;

        if (mealCounterValueEl) {
          mealCounterValueEl.textContent = totalMeals;
        }
        if (mealCounterBreakdownEl) {
          mealCounterBreakdownEl.textContent = t("mealBreakdown", {
            balanceMeals,
            packageMeals,
          });
        }

        // Paket haklarÄ± kutusu
        if (packageTotalMealsEl) {
          packageTotalMealsEl.textContent = `${packageMeals} ${t("mealWord")}`;
        }
        if (packageLunchTagEl) {
          packageLunchTagEl.textContent = t("packageLunchTag", { n: pkg.lunchMeals || 0 });
        }
        if (packageDinnerTagEl) {
          packageDinnerTagEl.textContent = t("packageDinnerTag", { n: pkg.dinnerMeals || 0 });
        }

        const locale = currentLang === "de" ? "de-DE" : "tr-TR";

        // Son iÅŸlem
        if (txs.length > 0) {
          const last = txs[0];
          const dateStr = new Date(last.created_at).toLocaleString(locale);
          const sign = last.type === "load" ? "+" : "-";
          const amountStr = sign + formatTL(Math.abs(last.amount)).replace("â‚º ", "");
          document.getElementById("lastTxnText").textContent =
            t("lastTxnSome", { date: dateStr, amount: amountStr });
        } else {
          document.getElementById("lastTxnText").textContent = t("lastTxnNone");
        }

        const weekCount = txs.length;
        document.getElementById("statWeekCount").textContent =
          t("statWeekCount", { n: weekCount });

        const spendTx = txs.filter((t) => t.type === "spend" && t.amount < 0);
        const avg =
          spendTx.length > 0
            ? Math.abs(spendTx.reduce((s, t) => s + t.amount, 0)) / spendTx.length
            : 0;
        document.getElementById("statAvgMeal").textContent =
          t("statAvgMeal", { price: formatTL(avg) });

        const createdDate = new Date(user.created_at).toLocaleDateString(locale);
        document.getElementById("statSince").textContent =
          t("statSince", { date: createdDate });

        const monthSpend = Math.abs(
          spendTx.reduce((s, t) => s + t.amount, 0)
        );
        const limit = 1000;
        document.getElementById("monthSummary").textContent =
          t("monthSummary", { spend: formatTL(monthSpend), limit: formatTL(limit) });
        const ratio = Math.min(monthSpend / limit, 1);
        document.getElementById("progressFill").style.width = (ratio * 100).toFixed(0) + "%";

        const lastSpend = spendTx[0];
        document.getElementById("todayEstimate").textContent =
          lastSpend ? formatTL(Math.abs(lastSpend.amount)) : t("todayEstimateZero");

        // Ä°ÅŸlem listesi
        const txListEl = document.getElementById("txList");
        txListEl.innerHTML = "";
        if (txs.length === 0) {
          txListEl.innerHTML =
            '<li class="list-item"><div>' + t("txNone") + "</div></li>";
        } else {
          txs.forEach((tx) => {
            const li = document.createElement("li");
            li.className = "list-item";

            const left = document.createElement("div");
            const title = document.createElement("div");
            title.textContent =
              tx.type === "load"
                ? t("txOnlineLoad")
                : (tx.description || t("txSpendDefault"));
            const info = document.createElement("div");
            info.className = "muted";
            info.textContent = new Date(tx.created_at).toLocaleString(locale);
            left.appendChild(title);
            left.appendChild(info);

            const right = document.createElement("div");
            right.style.textAlign = "right";
            const amount = document.createElement("div");
            amount.textContent =
              (tx.type === "load" ? "+" : "-") +
              formatTL(Math.abs(tx.amount)).replace("â‚º ", "");
            if (tx.type === "load") {
              amount.style.color = "var(--tau-green)";
            }
            right.appendChild(amount);

            li.appendChild(left);
            li.appendChild(right);
            txListEl.appendChild(li);
          });
        }

        // En sonda, seÃ§ili para birimine gÃ¶re ana bakiye gÃ¶sterimi:
        renderBalanceCurrency();
      } catch (err) {
        console.error(err);
        window.location.href = "/";
      }
    }

    // -------- HAVA DURUMU (OpenWeather) --------
    async function loadWeather() {
      if (!OPENWEATHER.apiKey) {
        if (weatherErr) {
          weatherErr.style.display = "block";
          weatherErr.textContent = currentLang === "de"
            ? "Bitte OpenWeather API-SchlÃ¼ssel hinterlegen."
            : "LÃ¼tfen OpenWeather API anahtarÄ±nÄ± ekleyin.";
        }
        return;
      }
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${OPENWEATHER.lat}&lon=${OPENWEATHER.lon}&units=metric&lang=${currentLang}&appid=${OPENWEATHER.apiKey}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("bad status");
        const data = await res.json();

        const temp = Math.round(data.main.temp);
        const feels = Math.round(data.main.feels_like);
        const desc = (data.weather && data.weather[0] && data.weather[0].description) ? data.weather[0].description : "â€”";
        const icon = (data.weather && data.weather[0] && data.weather[0].icon) ? data.weather[0].icon : "01d";
        const wind = data.wind?.speed ?? 0;
        const hum = data.main?.humidity ?? 0;

        if (weatherTemp) weatherTemp.textContent = `${temp}Â°C`;
        if (weatherDesc) {
          const txt = desc ? desc.charAt(0).toUpperCase() + desc.slice(1) : "â€”";
          weatherDesc.textContent = txt;
        }
        if (weatherIcon) weatherIcon.src = `https://openweathermap.org/img/wn/${icon}@2x.png`;
        if (weatherFeels) weatherFeels.textContent = t("weatherFeels", { v: feels });
        if (weatherWind) weatherWind.textContent = t("weatherWind", { v: wind });
        if (weatherHum) weatherHum.textContent = t("weatherHum", { v: hum });
        if (weatherErr) weatherErr.style.display = "none";
      } catch (e) {
        console.error(e);
        if (weatherErr) {
          weatherErr.style.display = "block";
          weatherErr.textContent = t("weatherError");
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadUser();
      loadWeather();
    });
  </script>
</body>
</html>
